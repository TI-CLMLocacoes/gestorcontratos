<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Integrado de TI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .sidebar { 
            transition: transform 0.3s ease-in-out;
            z-index: 50; /* Garante que o menu fique por cima */
        }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .table-auto th, .table-auto td { padding: 12px 10px; font-size: 0.875rem; text-align: left; vertical-align: middle; }
        .table-auto td:last-child { width: 120px; text-align: center; }
        .expiring-soon { background-color: #fef9c3 !important; }
        .expiring-soon:hover { background-color: #fef08a !important; }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            padding: 1rem;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="initial-loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-600">A carregar aplicação...</p>
    </div>
    
    <div id="action-loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-600">A processar...</p>
    </div>

    <!-- Ecrã de Login -->
    <div id="login-view" class="hidden flex items-center justify-center h-screen bg-gray-200">
        <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
            <div class="text-center mb-8">
                 <i class="fas fa-tasks text-4xl text-blue-600"></i>
                <h1 class="text-3xl font-extrabold text-gray-800 mt-2">TI - Gestor</h1>
            </div>
            
            <div id="auth-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden" role="alert">
                <span class="block sm:inline" id="auth-error-message"></span>
            </div>

            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Palavra-passe</label>
                    <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-300">Entrar</button>
            </form>

            <p class="text-center text-sm text-gray-600 mt-6">
                Não tem uma conta? <a href="#" id="show-register" class="font-medium text-blue-600 hover:text-blue-800">Crie uma aqui</a>.
            </p>
        </div>
    </div>

     <!-- Ecrã de Registo -->
    <div id="register-view" class="hidden flex items-center justify-center h-screen bg-gray-200">
        <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
            <div class="text-center mb-8">
                 <i class="fas fa-tasks text-4xl text-blue-600"></i>
                <h1 class="text-3xl font-extrabold text-gray-800 mt-2">Criar Nova Conta</h1>
            </div>
            
            <div id="register-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden" role="alert">
                <span class="block sm:inline" id="register-error-message"></span>
            </div>
            
            <form id="register-form">
                <div class="mb-4">
                    <label for="register-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="register-password" class="block text-sm font-medium text-gray-700">Palavra-passe (mín. 6 caracteres)</label>
                    <input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-300">Registar</button>
            </form>

             <p class="text-center text-sm text-gray-600 mt-6">
                Já tem uma conta? <a href="#" id="show-login" class="font-medium text-blue-600 hover:text-blue-800">Entre aqui</a>.
            </p>
        </div>
    </div>

    <!-- Aplicação Principal (inicialmente escondida) -->
    <div id="app-view" class="hidden h-screen">
        <div class="flex h-full">
            <!-- Sidebar -->
            <aside id="sidebar" class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 sidebar">
                <a href="#" class="text-white flex items-center space-x-2 px-4">
                    <i class="fas fa-tasks text-2xl"></i>
                    <span class="text-2xl font-extrabold">TI - Gestor</span>
                </a>
                <nav>
                    <p class="px-4 text-xs text-gray-400 uppercase mb-2">Dashboards</p>
                    <a href="#" onclick="showView('dashboard-linhas')" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 bg-gray-700"><i class="fas fa-chart-pie mr-2"></i>Linhas Móveis</a>
                    <a href="#" onclick="showView('dashboard-ti')" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-chart-line mr-2"></i>Contratos de TI</a>
                    <hr class="my-4 border-gray-600">
                    <p class="px-4 text-xs text-gray-400 uppercase mb-2">Gestão de Linhas Móveis</p>
                    <a href="#" onclick="showView('linhas')" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-sim-card mr-2"></i>Linhas</a>
                    <a href="#" onclick="showView('operadoras')" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-broadcast-tower mr-2"></i>Operadoras</a>
                    <a href="#" onclick="showView('setores')" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-sitemap mr-2"></i>Setores</a>
                    <a href="#" onclick="showView('usuarios')" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-users mr-2"></i>Usuários</a>
                    <hr class="my-4 border-gray-600">
                    <p class="px-4 text-xs text-gray-400 uppercase mb-2">Gestão de Contratos de TI</p>
                    <a href="#" onclick="showView('atividades')" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-stopwatch mr-2"></i>Atividades</a>
                    <a href="#" onclick="showView('projetos')" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-project-diagram mr-2"></i>Projetos</a>
                    <a href="#" onclick="showView('contratos')" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-file-signature mr-2"></i>Contratos</a>
                    <a href="#" onclick="showView('servicos')" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-concierge-bell mr-2"></i>Serviços</a>
                    <a href="#" onclick="showView('fornecedores')" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-building mr-2"></i>Fornecedores</a>
                    <a href="#" onclick="showView('analistas')" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-users-cog mr-2"></i>Analistas</a>
                </nav>
            </aside>

            <!-- Main Content -->
            <div id="main-content" class="flex-1 flex flex-col overflow-hidden main-content">
                <header class="flex justify-between items-center p-4 bg-white border-b-2">
                    <button id="menu-button" class="text-gray-500 focus:outline-none md:hidden"><i class="fas fa-bars text-2xl"></i></button>
                    <div class="flex items-center space-x-4">
                        <span id="user-email" class="text-sm text-gray-600"></span>
                        <button id="logout-button" class="bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600"><i class="fas fa-sign-out-alt mr-2"></i>Sair</button>
                    </div>
                </header>
                
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                    <!-- VIEW: Dashboard Linhas -->
                    <div id="view-dashboard-linhas" class="view">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800">Visão Geral - Linhas Móveis</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                             <div class="bg-white p-5 rounded-xl shadow-md stat-card transition-transform duration-300"><div class="flex items-center"><div class="bg-red-500 text-white rounded-full p-3 mr-4"><i class="fas fa-exclamation-triangle fa-2x"></i></div><div><p class="text-sm text-gray-500">Linhas a Cancelar</p><p id="stat-cancelar" class="text-3xl font-bold text-gray-800">0</p></div></div></div>
                             <div class="bg-white p-5 rounded-xl shadow-md stat-card transition-transform duration-300"><div class="flex items-center"><div class="bg-green-500 text-white rounded-full p-3 mr-4"><i class="fas fa-check-circle fa-2x"></i></div><div><p class="text-sm text-gray-500">Total de Linhas Ativas</p><p id="stat-ativas" class="text-3xl font-bold text-gray-800">0</p></div></div></div>
                             <div class="bg-white p-5 rounded-xl shadow-md stat-card transition-transform duration-300"><div class="flex items-center"><div class="bg-blue-500 text-white rounded-full p-3 mr-4"><i class="fas fa-dollar-sign fa-2x"></i></div><div><p class="text-sm text-gray-500">Custo Mensal Total</p><p id="stat-custo-total-linhas" class="text-3xl font-bold text-gray-800">R$ 0,00</p></div></div></div>
                             <div class="bg-white p-5 rounded-xl shadow-md stat-card transition-transform duration-300"><div class="flex items-center"><div class="bg-yellow-500 text-white rounded-full p-3 mr-4"><i class="fas fa-box-open fa-2x"></i></div><div><p class="text-sm text-gray-500">Linhas Disponíveis</p><p id="stat-disponiveis" class="text-3xl font-bold text-gray-800">0</p></div></div></div>
                        </div>
                        <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-md"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-700">Custo de Linhas por Setor</h3></div><div class="mx-auto w-full max-w-xs"><canvas id="chart-custo-setor"></canvas></div></div>
                            <div class="bg-white p-6 rounded-xl shadow-md"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-700">Total de Linhas por Setor</h3><button onclick="toggleLegend('legend-linhas-setor')" class="text-gray-500 hover:text-gray-800 text-sm"><i class="fas fa-list-ul mr-1"></i> Legenda</button></div><div id="chart-linhas-setor" class="space-y-4"></div><div id="legend-linhas-setor" class="mt-4 text-sm space-y-2 hidden border-t pt-4"></div></div>
                        </div>
                    </div>

                    <!-- VIEW: Dashboard TI -->
                    <div id="view-dashboard-ti" class="view hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-800">Visão Geral - TI</h2>
                            <div id="dashboard-ti-filters" class="flex space-x-2">
                                <button onclick="renderDashboardTI('currentMonth')" class="db-filter-btn-ti bg-blue-600 text-white px-3 py-1 rounded-md text-sm">Este Mês</button>
                                <button onclick="renderDashboardTI('lastMonth')" class="db-filter-btn-ti bg-white text-gray-700 px-3 py-1 rounded-md text-sm border">Mês Passado</button>
                                <button onclick="renderDashboardTI('last90days')" class="db-filter-btn-ti bg-white text-gray-700 px-3 py-1 rounded-md text-sm border">Últimos 90 dias</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-5 gap-6">
                            <div class="bg-white p-5 rounded-xl shadow-md stat-card transition-transform duration-300"><div class="flex items-center"><div class="bg-blue-500 text-white rounded-full p-3 mr-4"><i class="fas fa-dollar-sign fa-2x"></i></div><div><p class="text-sm text-gray-500">Custo em Projetos</p><p id="stat-custo-total-ti" class="text-3xl font-bold text-gray-800">R$ 0,00</p></div></div></div>
                            <div class="bg-white p-5 rounded-xl shadow-md stat-card transition-transform duration-300"><div class="flex items-center"><div class="bg-green-500 text-white rounded-full p-3 mr-4"><i class="fas fa-clock fa-2x"></i></div><div><p class="text-sm text-gray-500">Horas em Projetos</p><p id="stat-horas-totais-ti" class="text-3xl font-bold text-gray-800">0h 00m</p></div></div></div>
                            <div class="bg-white p-5 rounded-xl shadow-md stat-card transition-transform duration-300"><div class="flex items-center"><div class="bg-purple-500 text-white rounded-full p-3 mr-4"><i class="fas fa-wrench fa-2x"></i></div><div><p class="text-sm text-gray-500">Custos Avulsos</p><p id="stat-custo-avulso-ti" class="text-3xl font-bold text-gray-800">R$ 0,00</p></div></div></div>
                            <div class="bg-white p-5 rounded-xl shadow-md stat-card transition-transform duration-300"><div class="flex items-center"><div class="bg-yellow-500 text-white rounded-full p-3 mr-4"><i class="fas fa-project-diagram fa-2x"></i></div><div><p class="text-sm text-gray-500">Projetos Ativos</p><p id="stat-projetos-ativos-ti" class="text-3xl font-bold text-gray-800">0</p></div></div></div>
                            <div class="bg-white p-5 rounded-xl shadow-md stat-card transition-transform duration-300"><div class="flex items-center"><div class="bg-red-500 text-white rounded-full p-3 mr-4"><i class="fas fa-file-signature fa-2x"></i></div><div><p class="text-sm text-gray-500">Contratos Vencendo</p><p id="stat-contratos-vencendo-ti" class="text-3xl font-bold text-gray-800">0</p></div></div></div>
                        </div>
                        <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-md"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-700">Custo por Projeto (Período)</h3><button onclick="toggleLegend('legend-custo-projeto-ti')" class="text-gray-500 hover:text-gray-800 text-sm"><i class="fas fa-list-ul mr-1"></i> Legenda</button></div><div id="chart-custo-projeto-ti" class="space-y-4"></div><div id="legend-custo-projeto-ti" class="mt-4 text-sm space-y-2 hidden border-t pt-4"></div></div>
                            <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-gray-700 mb-4">Atividades Recentes</h3><ul id="lista-atividades-recentes-ti" class="space-y-4"></ul></div>
                        </div>
                    </div>

                    <!-- VIEWS para cada entidade -->
                    <div id="view-fornecedores" class="view hidden"></div>
                    <div id="view-contratos" class="view hidden"></div>
                    <div id="view-projetos" class="view hidden"></div>
                    <div id="view-analistas" class="view hidden"></div>
                    <div id="view-atividades" class="view hidden"></div>
                    <div id="view-servicos" class="view hidden"></div>
                    <div id="view-details" class="view hidden"></div>
                    <div id="view-linhas" class="view hidden"></div>
                    <div id="view-operadoras" class="view hidden"></div>
                    <div id="view-setores" class="view hidden"></div>
                    <div id="view-usuarios" class="view hidden"></div>
                </main>
            </div>
        </div>
    </div>

    <!-- MODAL Genérico -->
    <div id="modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop"><div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-8 modal-content transform scale-95"><div class="flex justify-between items-center mb-6"><h3 id="modal-title" class="text-2xl font-bold text-gray-800"></h3><button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><div id="modal-body"></div></div></div>

<script type="module">
    // ---------- IMPORTS E CONFIGURAÇÃO DO FIREBASE ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDFc5hzSOjBR9Mmbolc1edJFTQm3BKHFpw",
  authDomain: "gestorcontratosclm.firebaseapp.com",
  projectId: "gestorcontratosclm",
  storageBucket: "gestorcontratosclm.appspot.com",
  messagingSenderId: "538940293921",
  appId: "1:538940293921:web:a275a88061661fde98f460",
  measurementId: "G-JY1B4YX6ZJ"
};

    // Variáveis globais para instâncias do Firebase
    let db, auth;
    let authReady = false;

    // VERIFICAÇÃO DA CONFIGURAÇÃO ANTES DE INICIALIZAR
    if (firebaseConfig.apiKey.startsWith("COLE_AQUI")) {
        const initialLoading = document.getElementById('initial-loading-overlay');
        initialLoading.innerHTML = `
            <div class="text-center p-4 bg-white rounded-lg shadow-lg">
                <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Configuração do Firebase Incompleta</h2>
                <p class="text-gray-600">Por favor, siga o guia de configuração para criar o seu projeto Firebase e cole as suas chaves de configuração no ficheiro HTML para que a aplicação possa funcionar.</p>
            </div>
        `;
    } else {
        // Inicialização do Firebase (uma única vez)
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // ---------- AUTENTICAÇÃO E INICIALIZAÇÃO ----------
            onAuthStateChanged(auth, (user) => {
                authReady = true;
                handleAuthState(user);
            });
        } catch (error) {
            console.error("Erro ao inicializar o Firebase:", error);
            const initialLoading = document.getElementById('initial-loading-overlay');
            initialLoading.innerHTML = `<div class="text-center p-4 bg-white rounded-lg shadow-lg"><p class="text-red-500">Erro crítico ao inicializar a aplicação. Verifique a consola (F12) para mais detalhes.</p></div>`;
        }
    }
    
    function handleAuthState(user) {
        if (!authReady) return;

        const initialLoading = document.getElementById('initial-loading-overlay');
        initialLoading.classList.add('hidden');

        if (user && !user.isAnonymous) {
            userId = user.uid;
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('register-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            loadAllData();
        } else {
            userId = null;
            document.getElementById('app-view').classList.add('hidden');
            document.getElementById('register-view').classList.add('hidden');
            document.getElementById('login-view').classList.remove('hidden');
        }
    }


    // Variáveis globais da aplicação
    let currentView = 'dashboard-linhas';
    let userId = null;
    let custoSetorChart = null;

    const state = {
        fornecedores: [], contratos: [], projetos: [], analistas: [], atividades: [], servicos: [],
        operadoras: [], setores: [], usuarios: [], linhas: [],
        tiposContrato: ['Serviços de TI', 'Sistemas Corporativos', 'Segurança da Informação', 'Softwares Especializados', 'Softwares Operacionais', 'Aplicações Web', 'CRM', 'Recursos Humanos']
    };
    
    // Anexa as funções ao objeto window para que possam ser chamadas pelo HTML (onclick)
    window.showView = showView;
    window.renderDashboardLinhas = renderDashboardLinhas;
    window.renderDashboardTI = renderDashboardTI;
    window.showForm = showForm;
    window.deleteItem = deleteItem;
    window.closeModal = closeModal;
    window.handleSubmit = handleSubmit;
    window.handleTipoContratoChange = handleTipoContratoChange;
    window.updateActivityFormFilters = updateActivityFormFilters;
    window.exportToCSV = exportToCSV;
    window.toggleLegend = toggleLegend;
    window.showImportModal = showImportModal;
    window.handleCSVImport = handleCSVImport;
    window.downloadCSVTemplate = downloadCSVTemplate;

    document.addEventListener('DOMContentLoaded', () => {
        setupEventListeners();
    });

    function setupEventListeners() {
        document.getElementById('menu-button').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('-translate-x-full'));
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('bg-gray-700'));
                e.currentTarget.classList.add('bg-gray-700');
                const sidebar = document.getElementById('sidebar');
                if (!sidebar.classList.contains('md:relative')) sidebar.classList.add('-translate-x-full');
            });
        });

        // Eventos dos formulários de autenticação
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('register-form').addEventListener('submit', handleRegister);
        document.getElementById('logout-button').addEventListener('click', handleLogout);

        document.getElementById('show-register').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('register-view').classList.remove('hidden');
        });
         document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('register-view').classList.add('hidden');
            document.getElementById('login-view').classList.remove('hidden');
        });
    }
    
    // ---------- FUNÇÕES DE AUTENTICAÇÃO ----------
    async function handleLogin(e) {
        e.preventDefault();
        const actionLoading = document.getElementById('action-loading-overlay');
        actionLoading.classList.remove('hidden');

        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const errorDiv = document.getElementById('auth-error');
        const errorMessage = document.getElementById('auth-error-message');

        try {
            await signInWithEmailAndPassword(auth, email, password);
            errorDiv.classList.add('hidden');
        } catch (error) {
            errorMessage.textContent = "Email ou palavra-passe inválidos.";
            errorDiv.classList.remove('hidden');
            console.error("Erro de login:", error.message);
        } finally {
            actionLoading.classList.add('hidden');
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        const actionLoading = document.getElementById('action-loading-overlay');
        actionLoading.classList.remove('hidden');
        
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const errorDiv = document.getElementById('register-error');
        const errorMessage = document.getElementById('register-error-message');
        
        if (password.length < 6) {
            errorMessage.textContent = "A palavra-passe deve ter pelo menos 6 caracteres.";
            errorDiv.classList.remove('hidden');
            actionLoading.classList.add('hidden');
            return;
        }

        try {
            await createUserWithEmailAndPassword(auth, email, password);
            errorDiv.classList.add('hidden');
        } catch (error) {
             if (error.code === 'auth/email-already-in-use') {
                errorMessage.textContent = 'Este email já está a ser utilizado.';
            } else {
                errorMessage.textContent = 'Ocorreu um erro ao criar a conta.';
            }
            errorDiv.classList.remove('hidden');
            console.error("Erro de registo:", error.message);
        } finally {
            actionLoading.classList.add('hidden');
        }
    }
    
    async function handleLogout() {
        try {
            await signOut(auth);
        } catch(error) {
            console.error("Erro ao sair:", error);
        }
    }


    // ---------- GESTÃO DE DADOS (FIRESTORE) ----------
    function loadAllData() {
        if (!userId || !db) return;
        const collections = ['fornecedores', 'contratos', 'projetos', 'analistas', 'servicos', 'atividades', 'tiposContrato', 'operadoras', 'setores', 'usuarios', 'linhas'];
        
        collections.forEach(entityName => {
            const collRef = collection(db, `users/${userId}/${entityName}`);
            onSnapshot(collRef, (querySnapshot) => {
                const items = [];
                querySnapshot.forEach((doc) => {
                    items.push({ id: doc.id, ...doc.data() });
                });

                if(entityName === 'tiposContrato' && items.length > 0) {
                    state.tiposContrato = items[0].values; 
                } else if(entityName !== 'tiposContrato') {
                    state[entityName] = items;
                }
                
                if (currentView === entityName) {
                    renderEntityListView(entityName);
                } else if (currentView.startsWith('dashboard')) {
                    renderDashboardTI();
                    renderDashboardLinhas();
                } else if (currentView.startsWith('details')) {
                    const [_, entity, id] = currentView.split(':');
                    renderDetailsView(entity, id);
                }
            }, (error) => {
                console.error(`Erro ao carregar ${entityName}:`, error);
            });
        });
    }

    // ---------- GESTÃO DE VIEWS E MODAIS ----------
    function showView(viewName, detailsId = null) {
        if (detailsId) {
             currentView = `details:${detailsId.entity}:${detailsId.id}`;
        } else {
            currentView = viewName; 
        }

        document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
        const activeView = document.getElementById(`view-${viewName}`);
        if(activeView) {
            activeView.classList.remove('hidden');
            
            if (!viewName.startsWith('dashboard')) {
                activeView.innerHTML = ''; 
            }

            switch(viewName) {
                case 'dashboard-linhas': renderDashboardLinhas(); break;
                case 'dashboard-ti': renderDashboardTI(); break;
                case 'details': renderDetailsView(detailsId.entity, detailsId.id); break;
                default: renderEntityListView(viewName); break;
            }
        }
    }

    function openModal(title, formHtml) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerHTML = formHtml;
        const modal = document.getElementById('modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
            modal.querySelector('.modal-backdrop')?.classList.add('opacity-100');
            modal.querySelector('.modal-content')?.classList.remove('scale-95');
        }, 10);
    }

    function closeModal() {
        const modal = document.getElementById('modal');
        modal.querySelector('.modal-backdrop')?.classList.remove('opacity-100');
        modal.querySelector('.modal-content')?.classList.add('scale-95');
        setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
    }

    // ---------- CONFIGURAÇÃO E RENDERIZAÇÃO DAS ENTIDADES ----------
    const entityConfig = {
        fornecedores: { title: "Fornecedores de TI", fields: { nome: "Nome", cnpj: "CNPJ", contato: "Contato" }, columns: item => `<td><a href="#" class="text-blue-600 hover:underline" onclick="showView('details', {entity: 'fornecedores', id: '${item.id}'})">${item.nome}</a></td><td>${item.cnpj || ''}</td><td>${item.contato || ''}</td>` },
        contratos: { title: "Contratos", fields: { numeroContrato: "Nº Contrato", descricao: "Descrição", tipoContrato: "Tipo", fornecedorId: "Fornecedor", dataContratacao: "Contratação", periodo: "Período", valorMensal: "Valor Mensal" }, columns: item => `<td class="whitespace-nowrap"><a href="#" class="text-blue-600 hover:underline" onclick="showView('details', {entity: 'contratos', id: '${item.id}'})">${item.numeroContrato}</a></td><td class="truncate max-w-xs" title="${item.descricao}">${item.descricao}</td><td class="whitespace-nowrap">${item.tipoContrato || 'N/A'}</td><td class="whitespace-nowrap">${getRelationName(item.fornecedorId, 'fornecedores')}</td><td class="whitespace-nowrap">${formatDate(item.dataContratacao)}</td><td class="whitespace-nowrap text-center">${item.periodo}</td><td class="whitespace-nowrap">${formatCurrency(item.valorMensal)}</td><td class="whitespace-nowrap">${formatDate(DATE_ADD(item.dataContratacao, item.periodo))}</td>`, extraHeaders: '<th>Vencimento</th>' },
        projetos: { title: "Projetos de TI", fields: { nome: "Nome", contratoId: "Contrato", status: "Status", orcamentoTotal: "Orçamento (R$)", bancoHoras: "Horas Contratadas" }, optionalFields: ['orcamentoTotal', 'bancoHoras'], columns: item => { const {consumedCost, consumedHours} = calculateProjectConsumption(item.id); const orcamento = parseFloat(item.orcamentoTotal) || 0; const horas = parseFloat(item.bancoHoras) || 0; const costPercent = orcamento > 0 ? (consumedCost / orcamento * 100).toFixed(0) : 0; const hoursPercent = horas > 0 ? (consumedHours / horas * 100).toFixed(0) : 0; return `<td><a href="#" class="text-blue-600 hover:underline" onclick="showView('details', {entity: 'projetos', id: '${item.id}'})">${item.nome}</a></td><td class="truncate max-w-xs" title="${getRelationName(item.contratoId, 'contratos', 'descricao')}">${getRelationName(item.contratoId, 'contratos', 'descricao')}</td><td>${item.status}</td><td>${renderProgressBar(costPercent, `${formatCurrency(consumedCost)} / ${formatCurrency(orcamento)}`)}</td><td>${renderProgressBar(hoursPercent, `${formatHours(consumedHours)} / ${formatHours(horas)}`)}</td>`; } },
        analistas: { title: "Analistas de TI", fields: { nome: "Nome", fornecedorId: "Fornecedor de TI", valorHoraEspecifico: "Valor Hora (R$)" }, columns: item => `<td>${item.nome}</td><td>${getRelationName(item.fornecedorId, 'fornecedores')}</td><td>${formatCurrency(item.valorHoraEspecifico)}</td>` },
        servicos: { title: "Serviços de TI", fields: { nome: "Nome do Serviço", descricao: "Descrição", contratoId: "Contrato (Opcional)" }, optionalFields: ['contratoId'], columns: item => `<td>${item.nome}</td><td class="truncate max-w-md" title="${item.descricao}">${item.descricao}</td><td class="truncate max-w-xs" title="${getRelationName(item.contratoId, 'contratos', 'descricao')}">${getRelationName(item.contratoId, 'contratos', 'descricao')}</td>` },
        atividades: { title: "Atividades de TI", fields: { fornecedorId: "Fornecedor", projetoId: "Projeto (Opcional)", analistaId: "Analista", servicoId: "Serviço", descricao: "Descrição", data: "Data", horaInicio: "Hora Início", horaTermino: "Hora Término", valorEspecifico: "Valor Específico (R$)" }, optionalFields: ['projetoId', 'analistaId', 'horaInicio', 'horaTermino', 'valorEspecifico'], columns: item => `<td class="whitespace-nowrap">${getRelationName(item.fornecedorId, 'fornecedores')}</td><td class="whitespace-nowrap">${getRelationName(item.projetoId, 'projetos')}</td><td class="whitespace-nowrap">${getRelationName(item.analistaId, 'analistas')}</td><td class="whitespace-nowrap">${getRelationName(item.servicoId, 'servicos')}</td><td class="truncate max-w-sm" title="${item.descricao}">${item.descricao}</td><td class="whitespace-nowrap">${formatDate(item.data)}</td><td class="whitespace-nowrap text-center">${item.horaInicio || '-'}</td><td class="whitespace-nowrap text-center">${item.horaTermino || '-'}</td><td class="whitespace-nowrap text-center">${formatCurrency(item.valorEspecifico)}</td><td class="whitespace-nowrap text-center">${formatHours(item.duracao)}</td><td class="whitespace-nowrap">${formatCurrency(item.custo)}</td>`, extraHeaders: '<th>Duração</th><th>Custo</th>' },
        operadoras: { title: "Operadoras", fields: { nome: "Nome da Operadora" }, columns: item => `<td>${item.nome}</td>` },
        setores: { title: "Setores", fields: { nome: "Nome do Setor" }, columns: item => `<td>${item.nome}</td>` },
        usuarios: { title: "Usuários", fields: { nome: "Nome do Usuário", setorId: "Setor" }, columns: item => `<td>${item.nome}</td><td>${getRelationName(item.setorId, 'setores')}</td>` },
        linhas: { title: "Linhas de Celular", fields: { numero: "Número com DDD", usuarioId: "Usuário", setorId: "Setor", operadoraId: "Operadora", custoMensal: "Custo Mensal (R$)", dataRenovacao: "Data de Renovação", status: "Status" }, columns: item => { const isExpiring = isExpiringSoon(item.dataRenovacao) && item.status === 'Ativa'; const statusColor = { 'Ativa': 'bg-green-100 text-green-800', 'Cancelada': 'bg-red-100 text-red-800', 'Inativa': 'bg-gray-100 text-gray-800', 'Disponível': 'bg-blue-100 text-blue-800'}[item.status] || ''; return `<td class="whitespace-nowrap">${item.numero}</td><td>${getRelationName(item.usuarioId, 'usuarios')}</td><td>${getRelationName(item.setorId, 'setores')}</td><td>${getRelationName(item.operadoraId, 'operadoras')}</td><td>${formatCurrency(item.custoMensal)}</td><td>${formatDate(item.dataRenovacao)}</td><td><span class="px-2 py-1 font-semibold leading-tight rounded-full ${statusColor}">${item.status}</span></td><td class="text-center font-bold ${isExpiring ? 'text-red-600' : 'text-gray-400'}">${isExpiring ? '<i class="fas fa-exclamation-circle mr-1"></i> Cancelar' : '-'}</td>`; }, extraHeaders: '<th>Ação Recomendada</th>' }
    };

    function renderEntityListView(entityName) {
        const config = entityConfig[entityName];
        const view = document.getElementById(`view-${entityName}`);
        
        let tableHeaders = Object.values(config.fields).map(h => `<th>${h}</th>`).join('');
        if (config.extraHeaders) tableHeaders += config.extraHeaders;

        if (entityName === 'projetos') {
             tableHeaders = `<th>Nome</th><th>Contrato</th><th>Status</th><th>Consumo Orçamento</th><th>Consumo Horas</th>`;
        }

        const importButton = entityName === 'linhas' ? `<button onclick="showImportModal()" class="bg-teal-600 text-white px-4 py-2 rounded-lg shadow hover:bg-teal-700 transition duration-300"><i class="fas fa-file-upload mr-2"></i> Importar</button>` : '';

        view.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">${config.title}</h2><div class="flex space-x-2">${importButton}<button onclick="exportToCSV('${entityName}')" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition duration-300"><i class="fas fa-file-csv mr-2"></i> Exportar</button><button onclick="showForm('${entityName}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition duration-300"><i class="fas fa-plus mr-2"></i> Adicionar</button></div></div><div class="bg-white rounded-xl shadow overflow-x-auto"><table class="w-full table-auto"><thead class="bg-gray-50 border-b-2 border-gray-200"><tr>${tableHeaders}<th>Ações</th></tr></thead><tbody id="${entityName}-table-body"></tbody></table></div>`;
        const tableBody = document.getElementById(`${entityName}-table-body`);
        tableBody.innerHTML = '';
        state[entityName].forEach(item => {
            const row = document.createElement('tr');
            const isExpiring = entityName === 'linhas' && isExpiringSoon(item.dataRenovacao) && item.status === 'Ativa';
            row.className = `border-b hover:bg-gray-50 ${isExpiring ? 'expiring-soon' : ''}`;
            row.innerHTML = `${config.columns(item)}<td class="text-center"><button onclick="showForm('${entityName}', '${item.id}')" class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-edit"></i></button><button onclick="deleteItem('${entityName}', '${item.id}')" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button></td>`;
            tableBody.appendChild(row);
        });
    }

    function renderProgressBar(percentage, text) {
        let color = 'bg-green-500';
        if (percentage > 75) color = 'bg-yellow-500';
        if (percentage >= 100) color = 'bg-red-500';
        return `<div class="w-full progress-bar-bg rounded-full h-5 relative text-gray-800 font-bold text-xs flex items-center justify-center" title="${text}"><div class="absolute left-0 top-0 h-full rounded-full progress-bar ${color}" style="width: ${Math.min(percentage, 100)}%;"></div><span class="z-10 relative">${text}</span></div>`;
    }

    // ---------- GESTÃO DE FORMULÁRIOS E DADOS (CRUD) ----------
    function showForm(entityName, id = null) {
        const isEditing = id !== null;
        const item = isEditing ? state[entityName].find(i => i.id === id) : {};
        const config = entityConfig[entityName];
        
        let formFieldsHtml = Object.entries(config.fields).map(([key, label]) => {
            const value = item[key] || '';
            const isRequired = !(config.optionalFields && config.optionalFields.includes(key));
            if (key.includes('Id')) return createSelectField(key, label, value, null, isRequired);
            if (key.includes('data')) return createInputField('date', key, label, value, isRequired);
            if (label.includes('R$')) return createInputField('number', key, label, value, isRequired);
            if (key === 'status') {
                if (entityName === 'linhas') {
                    const statusOptions = ['Ativa', 'Cancelada', 'Inativa', 'Disponível'].map(s => ({id: s, nome: s}));
                    return createSelectField('status', 'Status', value, statusOptions, isRequired);
                }
                 const statusOptions = ['Ativo', 'Pausado', 'Concluído'].map(s => ({id: s, nome: s}));
                 return createSelectField('status', 'Status', value, statusOptions, isRequired);
            }
            if (key === 'tipoContrato') {
                const tipos = state.tiposContrato.map(t => ({ id: t, nome: t }));
                tipos.push({ id: 'outro', nome: 'Outro (Especificar)' });
                const selectHtml = createSelectField('tipoContrato', 'Tipo de Contrato', value, tipos, isRequired, `onchange="handleTipoContratoChange(this.value)"`);
                const inputHtml = `<div id="novo-tipo-contrato-wrapper" class="hidden mt-4"><label for="novoTipoContrato" class="block text-sm font-medium text-gray-700">Novo Tipo de Contrato</label><input type="text" id="novoTipoContrato" name="novoTipoContrato" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>`;
                return `<div>${selectHtml}${inputHtml}</div>`;
            }
            return createInputField('text', key, label, value, isRequired);
        }).join('');

        const formHtml = `<form onsubmit="handleSubmit(event, '${entityName}', ${isEditing ? `'${id}'` : 'null'})"><div class="space-y-4">${formFieldsHtml}</div><div class="mt-8 flex justify-end"><button type="button" onclick="closeModal()" class="mr-3 bg-gray-200 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700">${isEditing ? 'Salvar Alterações' : 'Criar'}</button></div></form>`;
        
        openModal(`${isEditing ? 'Editar' : 'Adicionar'} ${config.title}`, formHtml);

        if (entityName === 'atividades') {
            const projetoSelect = document.getElementById('projetoId');
            const fornecedorSelect = document.getElementById('fornecedorId');
            
            if (isEditing && item.projetoId) {
                updateActivityFormFilters({ projectId: item.projetoId, selectedAnalistaId: item.analistaId, selectedServicoId: item.servicoId });
            } else if (isEditing && item.fornecedorId) {
                updateActivityFormFilters({ fornecedorId: item.fornecedorId, selectedAnalistaId: item.analistaId, selectedServicoId: item.servicoId });
            }

            projetoSelect.onchange = (e) => updateActivityFormFilters({ projectId: e.target.value });
            fornecedorSelect.onchange = (e) => updateActivityFormFilters({ fornecedorId: e.target.value });
        }
    }

    function createInputField(type, id, label, value, isRequired = true) {
        return `<div><label for="${id}" class="block text-sm font-medium text-gray-700">${label}</label><input type="${type}" id="${id}" name="${id}" value="${value}" ${type === 'number' ? 'step="0.01"' : ''} ${isRequired ? 'required' : ''} class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>`;
    }

    function createSelectField(key, label, value, customOptions = null, isRequired = true, extraAttributes = '') {
        let options = [];
        const relationName = key.replace('Id', '');
        const pluralMap = { fornecedor: 'fornecedores', contrato: 'contratos', projeto: 'projetos', analista: 'analistas', servico: 'servicos', operadora: 'operadoras', setor: 'setores', usuario: 'usuarios' };
        const pluralName = pluralMap[relationName] || relationName + 's';

        if (customOptions) options = customOptions;
        else options = state[pluralName]?.map(item => ({ id: item.id, nome: item.descricao ? `${item.numeroContrato} - ${item.descricao}` : item.nome })) || [];
        
        const optionsHtml = options.map(o => `<option value="${o.id}" ${o.id === value ? 'selected' : ''}>${o.nome}</option>`).join('');
        return `<div><label for="${key}" class="block text-sm font-medium text-gray-700">${label}</label><select id="${key}" name="${key}" ${isRequired ? 'required' : ''} ${extraAttributes} class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"><option value="">Selecione...</option>${optionsHtml}</select></div>`;
    }

    function handleTipoContratoChange(selectedValue) {
        const wrapper = document.getElementById('novo-tipo-contrato-wrapper');
        const input = document.getElementById('novoTipoContrato');
        wrapper.classList.toggle('hidden', selectedValue !== 'outro');
        input.required = selectedValue === 'outro';
        if (selectedValue !== 'outro') input.value = '';
    }

    function updateActivityFormFilters({ projectId, fornecedorId, selectedAnalistaId = null, selectedServicoId = null }) {
        const fornecedorSelect = document.getElementById('fornecedorId');
        const analistaSelect = document.getElementById('analistaId');
        const servicoSelect = document.getElementById('servicoId');
        
        analistaSelect.innerHTML = '<option value="">Selecione...</option>';
        servicoSelect.innerHTML = '<option value="">Selecione...</option>';

        let finalFornecedorId = fornecedorId;

        if (projectId) {
            const projeto = state.projetos.find(p => p.id === projectId);
            if (projeto) {
                const contrato = state.contratos.find(c => c.id === projeto.contratoId);
                if (contrato) {
                    finalFornecedorId = contrato.fornecedorId;
                    fornecedorSelect.value = finalFornecedorId;
                    fornecedorSelect.disabled = true;

                    // Filtra serviços por este contrato OU serviços sem contrato
                    const filteredServicos = state.servicos.filter(s => !s.contratoId || s.contratoId === contrato.id);
                    filteredServicos.forEach(s => servicoSelect.innerHTML += `<option value="${s.id}" ${s.id === selectedServicoId ? 'selected':''}>${s.nome}</option>`);
                }
            }
        } else {
            fornecedorSelect.disabled = false;
            if(finalFornecedorId) {
                // Filtra serviços por todos os contratos do fornecedor OU serviços sem contrato
                const contratosDoFornecedor = state.contratos.filter(c => c.fornecedorId === finalFornecedorId);
                const idsContratos = contratosDoFornecedor.map(c => c.id);
                const filteredServicos = state.servicos.filter(s => !s.contratoId || idsContratos.includes(s.contratoId));
                filteredServicos.forEach(s => servicoSelect.innerHTML += `<option value="${s.id}" ${s.id === selectedServicoId ? 'selected':''}>${s.nome}</option>`);
            }
        }

        if (finalFornecedorId) {
            const filteredAnalistas = state.analistas.filter(a => a.fornecedorId === finalFornecedorId);
            filteredAnalistas.forEach(a => analistaSelect.innerHTML += `<option value="${a.id}" ${a.id === selectedAnalistaId ? 'selected':''}>${a.nome}</option>`);
        }
    }

    async function handleSubmit(event, entityName, id) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const newItem = {};
        formData.forEach((value, key) => newItem[key] = value);
        
        if (entityName === 'contratos' && newItem.tipoContrato === 'outro') {
            const novoTipo = formData.get('novoTipoContrato').trim();
            if (novoTipo) {
                if (!state.tiposContrato.some(t => t.toLowerCase() === novoTipo.toLowerCase())) {
                    state.tiposContrato.push(novoTipo);
                    const tiposContratoDocRef = doc(db, `users/${userId}/tiposContrato`, 'main');
                    await setDoc(tiposContratoDocRef, { values: state.tiposContrato });
                }
                newItem.tipoContrato = novoTipo;
            } else { return; }
        }
        delete newItem.novoTipoContrato;

        if (entityName === 'atividades') {
            const valorEspecifico = parseFloat(newItem.valorEspecifico) || 0;
            newItem.duracao = (newItem.horaInicio && newItem.horaTermino) ? (new Date(`1970-01-01T${newItem.horaTermino}`) - new Date(`1970-01-01T${newItem.horaInicio}`)) / 3600000 : 0;
            if (valorEspecifico > 0) newItem.custo = valorEspecifico;
            else if (newItem.analistaId) {
                const analista = state.analistas.find(a => a.id === newItem.analistaId);
                newItem.custo = (newItem.duracao || 0) * (parseFloat(analista?.valorHoraEspecifico) || 0);
            } else newItem.custo = 0;
            
            // Garante que o fornecedor é salvo, mesmo se inferido
            if (newItem.projetoId && !newItem.fornecedorId) {
                const projeto = state.projetos.find(p => p.id === newItem.projetoId);
                if (projeto) {
                    const contrato = state.contratos.find(c => c.id === projeto.contratoId);
                    if (contrato) newItem.fornecedorId = contrato.fornecedorId;
                }
            } else if (!newItem.projetoId) {
                 const fornecedorSelect = document.getElementById('fornecedorId');
                 if(fornecedorSelect) newItem.fornecedorId = fornecedorSelect.value;
            }
        }
        
        try {
            if (id) {
                const docRef = doc(db, `users/${userId}/${entityName}`, id);
                await setDoc(docRef, newItem, { merge: true });
            } else {
                const collRef = collection(db, `users/${userId}/${entityName}`);
                await addDoc(collRef, newItem);
            }
        } catch (error) {
            console.error("Erro ao salvar no Firestore:", error);
            alert("Ocorreu um erro ao salvar os dados.");
        }

        closeModal();
    }

    async function deleteItem(entityName, id) {
        if (confirm(`Tem certeza que deseja excluir este item?`)) {
            try {
                const docRef = doc(db, `users/${userId}/${entityName}`, id);
                await deleteDoc(docRef);
            } catch(error) {
                console.error("Erro ao excluir do Firestore:", error);
                alert("Ocorreu um erro ao excluir o item.");
            }
        }
    }

    // ---------- CÁLCULOS E LÓGICA DE NEGÓCIO ----------
    function DATE_ADD(dateStr, months) { const date = new Date(dateStr); date.setMonth(date.getMonth() + parseInt(months)); return date; }
    function calculateProjectConsumption(projectId) {
        const activities = state.atividades.filter(a => a.projetoId === projectId);
        const consumedCost = activities.reduce((sum, a) => sum + (a.custo || 0), 0);
        const consumedHours = activities.reduce((sum, a) => sum + (a.duracao || 0), 0);
        return { consumedCost, consumedHours };
    }
    function isExpiringSoon(dateStr) {
        if (!dateStr) return false;
        const renewalDate = new Date(dateStr);
        const today = new Date();
        const thirtyDaysFromNow = new Date();
        thirtyDaysFromNow.setDate(today.getDate() + 30);
        return renewalDate <= thirtyDaysFromNow && renewalDate >= today;
    }

    // ---------- FUNÇÕES AUXILIARES (GETTERS E FORMATTERS) ----------
    function getRelationName(id, entityPlural, field = 'nome') {
        if (!id || !state[entityPlural]) return 'N/A';
        const item = state[entityPlural].find(i => i.id === id);
        return item ? item[field] : 'N/A';
    }
    function formatCurrency(value) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(parseFloat(value) || 0); }
    function formatDate(dateString) { if (!dateString) return 'N/A'; const date = new Date(dateString); const adjustedDate = new Date(date.getTime() + Math.abs(date.getTimezoneOffset()*60000)); return adjustedDate.toLocaleDateString('pt-BR'); }
    function formatHours(decimalHours) {
        if (isNaN(parseFloat(decimalHours)) || decimalHours === null) return '0h 00m';
        const hours = Math.floor(decimalHours);
        const minutes = Math.round((decimalHours - hours) * 60);
        return `${hours}h ${String(minutes).padStart(2, '0')}m`;
    }

    // ---------- RENDERIZAÇÃO DOS DASHBOARDS E DETALHES ----------
    function renderDashboardLinhas() {
        const expiringLines = state.linhas.filter(l => isExpiringSoon(l.dataRenovacao) && l.status === 'Ativa');
        const activeLines = state.linhas.filter(l => l.status === 'Ativa');
        const totalCost = activeLines.reduce((sum, l) => sum + (parseFloat(l.custoMensal) || 0), 0);
        const availableLines = state.linhas.filter(l => l.status === 'Disponível').length;

        document.getElementById('stat-cancelar').textContent = expiringLines.length;
        document.getElementById('stat-ativas').textContent = activeLines.length;
        document.getElementById('stat-custo-total-linhas').textContent = formatCurrency(totalCost);
        document.getElementById('stat-disponiveis').textContent = availableLines;

        const costBySector = {};
        const countBySector = {};
        activeLines.forEach(l => {
            const sectorName = getRelationName(l.setorId, 'setores') || 'Sem Setor';
            costBySector[sectorName] = (costBySector[sectorName] || 0) + (parseFloat(l.custoMensal) || 0);
            countBySector[sectorName] = (countBySector[sectorName] || 0) + 1;
        });
        
        const costCtx = document.getElementById('chart-custo-setor').getContext('2d');
        if (custoSetorChart) custoSetorChart.destroy();
        if (Object.keys(costBySector).length > 0) {
            custoSetorChart = new Chart(costCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(costBySector),
                    datasets: [{
                        data: Object.values(costBySector),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'],
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        } else {
             const chartContainer = document.getElementById('chart-custo-setor').parentElement;
             chartContainer.innerHTML = '<h3 class="font-bold text-gray-700 mb-4">Custo de Linhas por Setor</h3><p class="text-center text-gray-500">Nenhum custo registado.</p>';
        }


        const countChart = document.getElementById('chart-linhas-setor');
        const countLegend = document.getElementById('legend-linhas-setor');
        countChart.innerHTML = '';
        countLegend.innerHTML = '';
        const maxCount = Math.max(...Object.values(countBySector), 1);
        let legendHtml = '';
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
        const sortedSectors = Object.entries(countBySector).sort(([,a],[,b]) => b-a);
        
        if (sortedSectors.length > 0) {
            sortedSectors.forEach(([nome, count], index) => {
                const color = colors[index % colors.length];
                countChart.innerHTML += `<div><div class="flex justify-between text-sm text-gray-600"><span>${nome}</span><span>${count}</span></div><div class="w-full bg-gray-200 rounded-full h-2.5 mt-1"><div class="h-2.5 rounded-full" style="width: ${(count/maxCount*100)}%; background-color: ${color};"></div></div></div>`;
                legendHtml += `<div class="flex items-center"><span class="w-4 h-4 rounded-full mr-2" style="background-color: ${color};"></span><span>${nome}: ${count} linhas</span></div>`;
            });
            countLegend.innerHTML = legendHtml;
        } else {
             countChart.innerHTML = '<p class="text-center text-gray-500">Nenhuma linha registada.</p>';
             countLegend.classList.add('hidden');
        }
    }

    function renderDashboardTI(range = 'currentMonth') {
        document.querySelectorAll('.db-filter-btn-ti').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-white', 'text-gray-700');
        });
        const activeBtn = document.querySelector(`.db-filter-btn-ti[onclick="renderDashboardTI('${range}')"]`);
        if (activeBtn) {
            activeBtn.classList.add('bg-blue-600', 'text-white');
            activeBtn.classList.remove('bg-white', 'text-gray-700');
        }

        const today = new Date();
        let startDate, endDate = new Date();
        if (range === 'currentMonth') startDate = new Date(today.getFullYear(), today.getMonth(), 1);
        else if (range === 'lastMonth') {
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
        } else if (range === 'last90days') startDate = new Date(new Date().setDate(today.getDate() - 90));

        const atividadesPeriodo = state.atividades.filter(a => { const d = new Date(a.data); return d >= startDate && d <= endDate; });
        const atividadesComProjeto = atividadesPeriodo.filter(a => a.projetoId);
        const atividadesSemProjeto = atividadesPeriodo.filter(a => !a.projetoId);
        
        const custoTotalProjetos = atividadesComProjeto.reduce((sum, a) => sum + (a.custo || 0), 0);
        const horasTotaisProjetos = atividadesComProjeto.reduce((sum, a) => sum + (a.duracao || 0), 0);
        const custoTotalAvulso = atividadesSemProjeto.reduce((sum, a) => sum + (a.custo || 0), 0);
        
        const projetosAtivos = state.projetos.filter(p => p.status === 'Ativo').length;
        const thirtyDaysFromNow = new Date(); thirtyDaysFromNow.setDate(today.getDate() + 30);
        const contratosVencendo = state.contratos.filter(c => { const v = DATE_ADD(c.dataContratacao, c.periodo); return v <= thirtyDaysFromNow && v >= today; }).length;

        document.getElementById('stat-custo-total-ti').textContent = formatCurrency(custoTotalProjetos);
        document.getElementById('stat-horas-totais-ti').textContent = formatHours(horasTotaisProjetos);
        document.getElementById('stat-custo-avulso-ti').textContent = formatCurrency(custoTotalAvulso);
        document.getElementById('stat-projetos-ativos-ti').textContent = projetosAtivos;
        document.getElementById('stat-contratos-vencendo-ti').textContent = contratosVencendo;

        const custoPorProjeto = {};
        atividadesComProjeto.forEach(a => { const nome = getRelationName(a.projetoId, 'projetos'); custoPorProjeto[nome] = (custoPorProjeto[nome] || 0) + a.custo; });
        
        const chartContainer = document.getElementById('chart-custo-projeto-ti');
        const chartLegend = document.getElementById('legend-custo-projeto-ti');
        chartContainer.innerHTML = '';
        chartLegend.innerHTML = '';
        const maxCost = Math.max(...Object.values(custoPorProjeto), 1);
        let legendHtml = '';
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
        const sortedProjects = Object.entries(custoPorProjeto).sort(([,a],[,b]) => b-a);
        if (sortedProjects.length > 0) {
            sortedProjects.forEach(([nome, custo], index) => {
                 const color = colors[index % colors.length];
                chartContainer.innerHTML += `<div><div class="flex justify-between text-sm text-gray-600"><span>${nome}</span><span>${formatCurrency(custo)}</span></div><div class="w-full bg-gray-200 rounded-full h-2.5 mt-1"><div class="h-2.5 rounded-full" style="width: ${(custo/maxCost*100)}%; background-color: ${color};"></div></div></div>`;
                legendHtml += `<div class="flex items-center"><span class="w-4 h-4 rounded-full mr-2" style="background-color: ${color};"></span><span>${nome}: ${formatCurrency(custo)}</span></div>`;
            });
            chartLegend.innerHTML = legendHtml;
        } else { chartContainer.innerHTML = '<p class="text-center text-gray-500">Nenhum custo de projeto registrado no período.</p>'; }

        const listaRecentes = document.getElementById('lista-atividades-recentes-ti');
        listaRecentes.innerHTML = '';
        const recentActivities = state.atividades.sort((a, b) => new Date(b.data) - new Date(a.data)).slice(0, 5);
        if (recentActivities.length > 0) {
            recentActivities.forEach(a => listaRecentes.innerHTML += `<li class="flex items-center justify-between p-2 rounded hover:bg-gray-50"><div><p class="font-medium text-gray-800">${a.descricao}</p><p class="text-sm text-gray-500">${getRelationName(a.analistaId, 'analistas')} em ${getRelationName(a.projetoId, 'projetos')}</p></div><div class="text-right"><p class="font-semibold text-gray-700">${formatCurrency(a.custo)}</p><p class="text-xs text-gray-400">${formatDate(a.data)}</p></div></li>`);
        } else { listaRecentes.innerHTML = '<p class="text-center text-gray-500">Nenhuma atividade registrada.</p>'; }
    }

    function renderDetailsView(entityName, id) {
        const item = state[entityName].find(i => i.id === id);
        if (!item) { 
            document.getElementById('view-details').innerHTML = `<div class="text-center p-8 text-gray-500">A carregar detalhes...</div>`;
            return;
        }
        
        const view = document.getElementById('view-details');
        const config = entityConfig[entityName];
        
        let detailsHtml = `<div class="bg-white p-6 rounded-lg shadow-md"><dl class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-6">`;
        for (const [key, label] of Object.entries(config.fields)) {
            let value = item[key] || 'N/A';
            if (key.includes('Id')) value = getRelationName(item[key], key.replace('Id', '') + 's', config.fields[key].includes('Contrato') ? 'descricao' : 'nome');
            else if (key.includes('data')) value = formatDate(item[key]);
            else if (label.includes('R$')) value = formatCurrency(item[key]);
            else if (key === 'bancoHoras') value = formatHours(item[key]);
            detailsHtml += `<div class="col-span-1"><dt class="text-sm font-medium text-gray-500">${label}</dt><dd class="mt-1 text-lg text-gray-900">${value}</dd></div>`;
        }
        
        if (entityName === 'projetos') {
            const { consumedHours } = calculateProjectConsumption(id);
            detailsHtml += `<div class="col-span-1"><dt class="text-sm font-medium text-gray-500">Horas Consumidas</dt><dd class="mt-1 text-lg text-gray-900">${formatHours(consumedHours)}</dd></div>`;
        } else if (entityName === 'contratos') {
            const projectsOfContract = state.projetos.filter(p => p.contratoId === id);
            const totalHours = projectsOfContract.reduce((sum, p) => sum + (parseFloat(p.bancoHoras) || 0), 0);
            const consumedHours = projectsOfContract.reduce((sum, p) => sum + calculateProjectConsumption(p.id).consumedHours, 0);
             detailsHtml += `<div class="col-span-1"><dt class="text-sm font-medium text-gray-500">Total de Horas (Projetos)</dt><dd class="mt-1 text-lg text-gray-900">${formatHours(totalHours)}</dd></div>`;
             detailsHtml += `<div class="col-span-1"><dt class="text-sm font-medium text-gray-500">Total Consumido (Projetos)</dt><dd class="mt-1 text-lg text-gray-900">${formatHours(consumedHours)}</dd></div>`;
        }

        detailsHtml += `</dl></div>`;
        
        let relatedItemsHtml = '';
        if (entityName === 'contratos') {
            relatedItemsHtml += renderRelatedTable('Projetos Vinculados', state.projetos.filter(p => p.contratoId === id), entityConfig.projetos, 'projetos');
            relatedItemsHtml += renderRelatedTable('Serviços Vinculados', state.servicos.filter(s => s.contratoId === id), entityConfig.servicos, 'servicos');
        } else if (entityName === 'projetos') {
            relatedItemsHtml += renderRelatedTable('Atividades do Projeto', state.atividades.filter(a => a.projetoId === id), entityConfig.atividades, 'atividades');
        } else if (entityName === 'fornecedores') {
            relatedItemsHtml += renderRelatedTable('Contratos Vinculados', state.contratos.filter(c => c.fornecedorId === id), entityConfig.contratos, 'contratos');
            relatedItemsHtml += renderRelatedTable('Analistas Vinculados', state.analistas.filter(a => a.fornecedorId === id), entityConfig.analistas, 'analistas');
        }
        
        view.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">Detalhes de ${config.title}</h2><button onclick="showView('${entityName}')" class="bg-gray-500 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-600 transition duration-300"><i class="fas fa-arrow-left mr-2"></i> Voltar</button></div>${detailsHtml}${relatedItemsHtml}`;
    }

    function renderRelatedTable(title, data, config, relatedEntityName) {
        if (data.length === 0) return '';
        let headers;
        if (relatedEntityName === 'projetos') {
            headers = `<th>Nome</th><th>Contrato</th><th>Status</th><th>Consumo Orçamento</th><th>Consumo Horas</th>`;
        } else if (relatedEntityName === 'atividades'){
            headers = `<th>Fornecedor</th><th>Projeto</th><th>Analista</th><th>Serviço</th><th>Descrição</th><th>Data</th><th>Hora Início</th><th>Hora Término</th><th>Valor Específico</th><th>Duração</th><th>Custo</th>`;
        }
        else {
            headers = Object.values(config.fields).map(h => `<th>${h}</th>`).join('');
            if (config.extraHeaders) headers += config.extraHeaders;
        }
        
        let rows = data.map(item => `<tr>${config.columns(item)}</tr>`).join('');
        return `<div class="mt-6"><h3 class="text-2xl font-bold text-gray-800 mb-4">${title}</h3><div class="bg-white rounded-lg shadow overflow-x-auto"><table class="w-full table-auto"><thead class="bg-gray-50 border-b-2 border-gray-200"><tr>${headers}</tr></thead><tbody>${rows}</tbody></table></div></div>`;
    }

    // ---------- EXPORTAÇÃO PARA CSV ----------
    function exportToCSV(entityName) {
        const items = state[entityName];
        if (items.length === 0) { alert('Não há dados para exportar.'); return; }
        
        const config = entityConfig[entityName];
        const headers = Object.values(config.fields);
        if (config.extraHeaders) {
            config.extraHeaders.match(/<th>(.*?)<\/th>/g).forEach(h => headers.push(h.replace(/<\/?th>/g, '')));
        }
        
        const csvRows = [
            headers.join(','),
            ...items.map(item => {
                const row = Object.keys(config.fields).map(key => {
                    let value = item[key] || '';
                    if (key.includes('Id')) {
                         value = getRelationName(value, key.replace('Id', '') + 's', config.fields[key].includes('Contrato') ? 'descricao' : 'nome');
                    }
                    return `"${value}"`;
                });
                return row.join(',');
            })
        ];
        
        const csvString = csvRows.join('\r\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `${entityName}_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function toggleLegend(legendId) {
        const legend = document.getElementById(legendId);
        if(legend) {
            legend.classList.toggle('hidden');
        }
    }

    // ---------- IMPORTAÇÃO DE CSV ----------
    function showImportModal() {
        const formHtml = `
            <div class="space-y-4">
                <p class="text-sm text-gray-600">Para importar novas linhas, siga estes passos:</p>
                <ol class="list-decimal list-inside space-y-2 text-sm">
                    <li>Faça o download do nosso modelo CSV.</li>
                    <li>Preencha o ficheiro com os seus dados. A coluna <strong>numero</strong> é a única obrigatória.</li>
                    <li>Para as colunas <strong>usuario, setor e operadora</strong>, os nomes devem corresponder aos que já estão registados na aplicação para serem vinculados automaticamente. Se um nome não for encontrado ou o campo estiver vazio, a linha será importada e poderá preencher o dado manualmente mais tarde.</li>
                </ol>
                <a href="#" onclick="downloadCSVTemplate()" class="text-blue-600 hover:underline font-semibold"><i class="fas fa-download mr-2"></i>Download do Modelo CSV</a>
                <form onsubmit="handleCSVImport(event)" class="mt-4">
                    <div>
                        <label for="csvFile" class="block text-sm font-medium text-gray-700">Ficheiro CSV</label>
                        <input type="file" id="csvFile" name="csvFile" accept=".csv" required class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button type="button" onclick="closeModal()" class="mr-3 bg-gray-200 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-300">Cancelar</button>
                        <button type="submit" class="bg-teal-600 text-white px-5 py-2 rounded-lg hover:bg-teal-700">Importar</button>
                    </div>
                </form>
            </div>
        `;
        openModal("Importar Linhas de Celular", formHtml);
    }

    function downloadCSVTemplate() {
        const headers = ["numero", "usuario", "setor", "operadora", "custoMensal", "dataRenovacao", "status"];
        const csvString = headers.join(',');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "template_linhas.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    async function handleCSVImport(event) {
        event.preventDefault();
        const fileInput = document.getElementById('csvFile');
        if (fileInput.files.length === 0) {
            alert("Por favor, selecione um ficheiro.");
            return;
        }
        
        const actionLoading = document.getElementById('action-loading-overlay');
        actionLoading.classList.remove('hidden');
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                const text = e.target.result;
                const rows = text.split('\n').slice(1); // Remove cabeçalho
                const batch = writeBatch(db);
                let successCount = 0;
                let errorCount = 0;
                let errorMessages = [];

                for (const [index, row] of rows.entries()) {
                    if (!row.trim()) continue;

                    const columns = row.split(',').map(s => s.trim().replace(/"/g, ''));
                    
                    const numero = columns[0];
                    if (!numero) {
                        errorCount++;
                        errorMessages.push(`Linha ${index + 2}: Número da linha é obrigatório.`);
                        continue;
                    }
                    
                    const [ , usuarioNome, setorNome, operadoraNome, custoMensal, dataRenovacao, status] = columns;
                    
                    const usuario = state.usuarios.find(u => u.nome.toLowerCase() === (usuarioNome || '').toLowerCase());
                    const setor = state.setores.find(s => s.nome.toLowerCase() === (setorNome || '').toLowerCase());
                    const operadora = state.operadoras.find(o => o.nome.toLowerCase() === (operadoraNome || '').toLowerCase());

                    const newLinha = {
                        numero: numero || '',
                        usuarioId: usuario ? usuario.id : '',
                        setorId: setor ? setor.id : '',
                        operadoraId: operadora ? operadora.id : '',
                        custoMensal: custoMensal || '',
                        dataRenovacao: dataRenovacao || '',
                        status: status || 'Disponível'
                    };

                    const newDocRef = doc(collection(db, `users/${userId}/linhas`));
                    batch.set(newDocRef, newLinha);
                    successCount++;
                }
                
                await batch.commit();
                let summary = `${successCount} linhas importadas com sucesso.\n`;
                if(errorCount > 0) {
                    summary += `${errorCount} linhas falharam.\n\nPrimeiros erros:\n${errorMessages.slice(0, 5).join('\n')}`;
                }
                alert(summary);

            } catch (error) {
                alert("Ocorreu um erro ao processar o ficheiro.");
                console.error("Erro na importação:", error);
            } finally {
                actionLoading.classList.add('hidden');
                closeModal();
            }
        };
        
        reader.readAsText(file, "UTF-8");
    }

</script>
</body>
</html>
